# Detecção de Malware

Para um bom analista de segurança é importante saber identificar e diagnosticar sintomas de malware em seu sistema, para que ele desenvolva essa habilidade é importante muita prática e experiência, mas o objetivo deste material é munir o analista de ferramentas que o auxiliem no processo de diagnóstico do problema que ele está enfrentando no sistema de TI.

O primeiro processo de analise para verificar se um sistema está comprometido é encontrar seus indicadores, para isso precisamos segmentar o sistema em: redes, processos, comportamento e governança do sistema.

ANÁLISE TOP DOWN

Procurando os indicadores de malwares durante os processos do sistema:

* Virus
  * Processos desconhecidos no sistema, geralmente em segundo plano.
  * Arquivos corrompidos ou danificados.
  * Mensagens de erro incomuns.
  * Programas que não funcionam.
* Worms
  * Processos desconhecidos no sistema, geralmente em segundo plano.
  * Conexões com IPs/domínios (através de DNS reverso)  desconhecidos e em portas incomuns.
  * Envio excessivo de e-mails ou mensagens instantâneas.
  * Diminuição da velocidade da internet.
  * Arquivos consumindo muito espaço em disco.
* Adware
  * Excesso de anúncios pop-up.
  * Nova barra de ferramentas ou página inicial no navegador.
  * Redirecionamentos para sites desconhecidos.
* Trojans
  * Processos desconhecidos no sistema, geralmente em segundo plano.
  * Conexões com IPs/domínios (através de DNS reverso)  desconhecidos e em portas incomuns.
  * Arquivos inesperados baixados ou instalados.
  * Senhas ou informações confidenciais roubadas.
  * Programas que não funcionam corretamente.
* Ransomwares
  * Arquivos criptografados e inacessíveis.
  * Mensagens exigindo pagamento para descriptografar arquivos.
  * Bloqueio do acesso ao computador.
* Spywares
  * Processos desconhecidos no sistema, geralmente em segundo plano.
  * Conexões com IPs/domínios (através de DNS reverso)  desconhecidos e em portas incomuns.
  * Senhas previamente vazadas
  * Logs de camera sendo acionada constantemente
* Bots
  * Processos desconhecidos no sistema, geralmente em segundo plano, difíceis de detectar pois não são periódicos.
  * Conexões com IPs/domínios (através de DNS reverso)  desconhecidos e em portas incomuns, mas em momentos específicos que podem ser configurados para isso.
  * Computador lento ou travando.
  * Aumento do tráfego de internet sem explicação.
  * Dificuldade para acessar sites legítimos.
* Rootkits
  * Processos desconhecidos no sistema, geralmente em segundo plano, podem estabelecer conecções de rede periódicamente ou aleatóriamente com seu servidor de C2 para receber ou enviar instruções/dados.
  * Conexões com IPs/domínios (através de DNS reverso) desconhecidos e em portas incomuns.
  * Dificuldade para remover programas ou arquivos.
  * Impossibilidade de acessar configurações do sistema.
  * Programas desconhecidos em execução.
  * Tráfego de rede desconhecido, pode ocorrer em momentos específicos ou aleatórios em caso de C2 (Command & Control) no sistema
* Keyloggers
  * Processos desconhecidos no sistema, geralmente em segundo plano.
  * Em algum momento os keyloggers precisam transmitir os dados para um servidor, portanto:
  * Conexões com IPs/domínios (através de DNS reverso)  desconhecidos e em portas incomuns, mas em momentos específicos que podem ser configurados para isso.
* Bombas Lógicas
  * Desativação do computador ou arquivos em uma data ou hora específica.
  * Danos aos dados ou hardware do computador.
  * Comportamento incomum do sistema antes da data de ativação.



Alguns comandos para analisar o sistema em busca de malwares em intrusão e rede

Analisando sockets

* ss –rOl
* ss –antp
* ss -tunap
* nmap -sT -p- localhost => analisando portas abertas no localhost

No Wireshark aplicar o filtro:

* tcp.flags.syn == 1 and tcp.flags.ack == 0

&#x20;

Caso encontre algum domínio (website) suspeito no sistema basta fazer a busca por ele nos logs do sistema

* grep "suspicious.domain.com" /var/log/\*

Ao encontrar volume de tráfego em uma porta suspeita usando as ferramentas anteriores, basta:

* sudo tcpdump -i eth0 'tcp port 443'

&#x20;

Detecte hosts e usuarios suspeitos armazenados no seu sistema

* Linux:
  * cat /etc/hosts
  * cat /etc/passwd
  * getent passwd
* Windows:
  * Get-Content C:\Windows\System32\drivers\etc\hosts
  * Get-LocalUser
  * net user

Analise eventos do sistema

* Linux:
  * journalctl –fxe
  * less /var/log/auth.log #tail –f para ver em tempo real
  * less /var/log/syslog #tail –f para ver em tempo real
* Windows:
  * Get-WinEvent -LogName "Microsoft-Windows-Security-Auditing" -FilterXPath "\*\[System\[EventID=4657]]"
  * Get-WinEvent -LogName Security
  * Get-WinEvent -LogName System
  * Get-WinEvent -LogName Application -MaxEvents 100

Leia eventos do kernel

* Linux:
  * sudo dmesg
  * sudo dmesg | grep -I error
* Windows:
  * Ctrl + R => eventvwr.msc
  * Get-WinEvent -LogName System | Where-Object { $\_.ProviderName -eq "Microsoft-Windows-Kernel-General" -or $\_.ProviderName -eq "Microsoft-Windows-Kernel-Boot" }

Analisar permissões de determinado usuário a um arquivo, diretório, link simbólico (copia) ou executável

* Linux
  * ls –l /Path/Para/Recurso
* Windows
  * Get-Acl C:\Path\Para\Recurso



ANÁLISE BOTTOM UP&#x20;

Análise Estática

Aqui analisaremos indicadores do comportamento de um malware da ótica de seu momento de execução. O primeiro ponto seria fazer uma análise estática dos arquivos, analisando scripts, bibliotecas, nomes, extensões e hashes dos arquivos, endereços de ip, domínios e headers. Todos indicadores necessários para que possamos ter uma primeira informa sobre se aquele arquivo pode ou não ser um arquivo malicioso antes da tomada de decisão...

&#x20;

Ferramentas

* Analisadores:
  * Wireshark,
  * tcpdump,
  * Virus Total,
  * FileAlyzer,
  * Hash my Files,
  * Sandboxie
* Engenharia Reversa:
  * IDA,
  * x64dbg,
  * Detect It Easy,
  * PE Studio,
  * Strings,
  * Ghidra
* Intel:
  * Talos,
  * Pulsedive,
  * MITRE ATT\&CK,
  * CVE,
  * TorMap

Análise Dinâmica

O processo de analise dinâmica é o passo seguinte neste caso, pois se o arquivo não se manifestou como um malware sem interação com o mesmo, no momento em que ele interagir com um sistema isso pode ocorrer, mas vale ressaltar que alguns malwares já detectam se estã em sandboxes ou VMs e param de rodar seu processo malicioso para gerarem misdirection no analisador.

Aqui basicamente executaremos o arquivo em um ambiente controlado e isolado de todo o sistema.

Instalação e uso de equipamentos como IPS, IDS, NGFW e ATS

Análise de regras de AD para Windows e RWX para Linux
